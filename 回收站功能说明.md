# 回收站功能说明

## ✅ 新增功能

失效的IP会自动移到回收站，不再参与检测！

---

## 🎯 工作原理

### 自动移除失效IP

每次检测后：
1. ✅ **有效IP** - 保留在分组中，继续检测
2. ❌ **失效IP** - 自动移到回收站，不再检测
3. 📊 **回收站** - 保存失效IP的历史记录

### 回收站数据

每个失效IP保存:
- IP:端口
- ASN
- 国家
- 失效原因 (timeout, http_502, network_error等)
- 删除时间

---

## 📋 使用方法

### 1. 查看回收站

访问: https://fxpip.5671234.xyz

点击"回收站"标签，查看所有失效IP

### 2. 恢复IP

如果某个IP恢复正常:
1. 勾选要恢复的IP
2. 点击"恢复选中"
3. IP会恢复到第一个分组
4. 状态重置为"未检测"

### 3. 清空回收站

定期清理:
1. 点击"清空回收站"
2. 确认删除
3. 所有历史记录被清除

---

## 🔄 检测流程

```
┌─────────────┐
│  开始检测   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  检测所有IP │
└──────┬──────┘
       │
       ├─────► ✅ 有效IP → 保留在分组
       │
       └─────► ❌ 失效IP → 移到回收站
                           │
                           ▼
                    ┌──────────────┐
                    │   回收站     │
                    │ - 保存记录   │
                    │ - 不再检测   │
                    └──────────────┘
```

---

## 📊 数据统计

### Telegram通知

检测完成后会显示:
```
🔍 ProxyIP检测报告
⏰ 2026-02-26 19:30:00
📊 总:150 ✅120 ❌30

📋 失效原因: timeout:15 | http_502:10 | network_error:5

📦韩国→kr.example.com
✅
🗑️ 已移除8个失效IP
  1.2.3.4:443(123ms)
  5.6.7.8:443(156ms)
```

### Web界面

概览页面显示:
- 总检测数
- 有效数
- 失效数
- 每个分组移除的IP数量

---

## 🔧 API说明

### 获取回收站
```
GET /api/trash
```

返回:
```json
[
  {
    "ipPort": "1.2.3.4:443",
    "asn": "AS12345",
    "country": "韩国",
    "deletedReason": "timeout",
    "deletedAt": "2026-02-26T11:30:00.000Z"
  }
]
```

### 恢复IP
```
POST /api/restore
{
  "ipPorts": ["1.2.3.4:443"],
  "groupId": "kr"
}
```

### 清空回收站
```
DELETE /api/trash
```

---

## 💡 使用建议

### 1. 定期检查回收站

每周查看一次回收站:
- 分析失效原因
- 识别问题IP段
- 决定是否恢复

### 2. 失效原因分析

**timeout (超时)**
- 可能是临时网络问题
- 可以尝试恢复

**http_502 (服务器错误)**
- 代理服务器故障
- 建议不要恢复

**network_error (网络错误)**
- IP可能被封禁
- 建议不要恢复

### 3. 清理策略

建议每月清空一次回收站:
- 释放KV存储空间
- 保持数据整洁

---

## 🎯 优势

### 1. 提高检测效率
- ❌ 不再检测失效IP
- ⚡ 检测速度更快
- 💰 节省API调用

### 2. 保留历史记录
- 📊 分析失效原因
- 🔍 追踪IP质量
- 📈 优化IP来源

### 3. 灵活恢复
- 🔄 误判可以恢复
- 🛠️ IP修复后重新使用
- 📋 批量操作

---

## ⚠️ 注意事项

### 1. 恢复位置

恢复的IP会添加到**第一个分组**，如果需要添加到其他分组:
1. 先恢复
2. 在IP管理页面手动移动

### 2. 状态重置

恢复后IP状态为"未检测"，需要:
1. 手动触发检测
2. 或等待下次自动检测

### 3. 存储限制

回收站数据存储在KV中:
- 建议定期清理
- 避免占用过多空间

---

## 📈 数据示例

### 回收站记录

| IP:端口 | ASN | 国家 | 失效原因 | 删除时间 |
|---------|-----|------|----------|----------|
| 1.2.3.4:443 | AS12345 | 韩国 | timeout | 2026-02-26 11:30 |
| 5.6.7.8:443 | AS67890 | 日本 | http_502 | 2026-02-26 11:30 |
| 9.10.11.12:443 | AS11111 | 美国 | network_error | 2026-02-26 11:30 |

### 失效原因统计

```
timeout: 45%        (临时问题，可能恢复)
http_502: 30%       (服务器故障)
network_error: 20%  (网络问题)
api_fail: 5%        (API错误)
```

---

## 🎉 总结

回收站功能让你的IP管理更智能:
- ✅ 自动清理失效IP
- ✅ 保留历史记录
- ✅ 灵活恢复机制
- ✅ 提高检测效率

不用再手动删除失效IP了！

# GitHub Actions 配置指南

## 第一步: 获取Cloudflare凭证

### 1. 获取Account ID

**方法1: 从Cloudflare Dashboard获取**
1. 登录 https://dash.cloudflare.com
2. 点击任意一个域名进入
3. 在右侧边栏找到 "Account ID"，点击复制
4. 或者查看浏览器地址栏: `https://dash.cloudflare.com/账户ID/...`

**方法2: 使用wrangler命令**
```bash
wrangler whoami
```

### 2. 获取KV Namespace ID

**方法1: 从wrangler.toml查看**
```bash
cd c:\Users\Administrator\Desktop\proxyip-worker
cat wrangler.toml
```
找到 `id = "你的KV_ID"` 这一行

**方法2: 使用wrangler命令查询**
```bash
wrangler kv namespace list
```
找到你的KV命名空间，复制ID

### 3. 创建API Token

1. 访问 https://dash.cloudflare.com/profile/api-tokens
2. 点击 "Create Token"
3. 选择 "Create Custom Token"
4. 配置如下:

**Token名称**: `GitHub Actions ProxyIP`

**权限设置**:
- Account > Workers KV Storage > Edit
- Zone > DNS > Edit (如果需要自动解析DNS)

**Account Resources**:
- Include > 选择你的账户

**Zone Resources**:
- Include > 选择你的域名 (或All zones)

**TTL**: 可以设置永不过期

5. 点击 "Continue to summary"
6. 点击 "Create Token"
7. **重要**: 复制生成的Token (只显示一次!)

---

## 第二步: 配置GitHub仓库

### 1. 创建GitHub仓库

如果还没有仓库:
1. 访问 https://github.com/new
2. 仓库名: `proxyip-worker` (或其他名称)
3. 选择 Public 或 Private
4. 点击 "Create repository"

### 2. 配置Secrets

1. 进入你的GitHub仓库
2. 点击 Settings (设置)
3. 左侧菜单找到 "Secrets and variables" > "Actions"
4. 点击 "New repository secret"

添加以下3个Secrets:

**Secret 1: CF_ACCOUNT_ID**
- Name: `CF_ACCOUNT_ID`
- Value: 你的Cloudflare Account ID
- 点击 "Add secret"

**Secret 2: CF_KV_NAMESPACE_ID**
- Name: `CF_KV_NAMESPACE_ID`
- Value: 你的KV Namespace ID
- 点击 "Add secret"

**Secret 3: CF_API_TOKEN**
- Name: `CF_API_TOKEN`
- Value: 刚才创建的API Token
- 点击 "Add secret"

---

## 第三步: 推送代码到GitHub

### 方法1: 使用命令行

```bash
# 进入项目目录
cd c:\Users\Administrator\Desktop\proxyip-worker

# 初始化git仓库 (如果还没有)
git init

# 添加所有文件
git add .

# 提交
git commit -m "添加GitHub Actions自动检测"

# 关联远程仓库 (替换为你的仓库地址)
git remote add origin https://github.com/你的用户名/proxyip-worker.git

# 推送到GitHub
git branch -M main
git push -u origin main
```

### 方法2: 使用GitHub Desktop

1. 打开GitHub Desktop
2. File > Add Local Repository
3. 选择 `c:\Users\Administrator\Desktop\proxyip-worker`
4. 点击 "Publish repository"
5. 选择仓库名称和可见性
6. 点击 "Publish repository"

---

## 第四步: 验证运行

### 1. 查看Actions

1. 进入GitHub仓库
2. 点击 "Actions" 标签页
3. 应该能看到 "ProxyIP检测" 工作流

### 2. 手动触发测试

1. 点击左侧的 "ProxyIP检测"
2. 点击右侧的 "Run workflow" 按钮
3. 点击绿色的 "Run workflow" 确认
4. 等待几秒，刷新页面
5. 点击运行记录查看详细日志

### 3. 查看运行日志

点击运行记录后，可以看到:
- ✅ Checkout代码
- ✅ 设置Node.js
- ✅ 运行检测脚本

展开 "运行检测脚本" 可以看到详细的检测过程:
```
[*] 第一阶段(测速)开始: 150 个IP
    [+] 有效IP: 1.2.3.4:443        | 延迟: 123ms | 机房: HKG
    [+] 有效IP: 5.6.7.8:443        | 延迟: 156ms | 机房: LAX
[*] 第一阶段进度: 50/150 | 有效: 12 | 失效: 38
...
[+] 检测完成: 总计 150, 有效 45, 失效 105
```

---

## 第五步: 调整运行时间 (可选)

默认每4小时运行一次。如果要修改:

编辑 `.github/workflows/check-proxy.yml`:

```yaml
on:
  schedule:
    # 每6小时运行一次
    - cron: '0 */6 * * *'

    # 或者每天固定时间运行 (UTC时间)
    # 北京时间 00:00 = UTC 16:00 (前一天)
    # 北京时间 06:00 = UTC 22:00 (前一天)
    # 北京时间 12:00 = UTC 04:00
    # 北京时间 18:00 = UTC 10:00
    - cron: '0 16,22,4,10 * * *'
```

---

## 常见问题

### Q1: 如何查看检测结果?

A: 检测结果会自动写入Cloudflare KV，访问你的Workers管理界面查看:
```
https://你的域名/
```

### Q2: Actions运行失败怎么办?

A: 点击失败的运行记录，查看错误信息:
- `401 Unauthorized`: API Token权限不足或错误
- `404 Not Found`: Account ID或KV Namespace ID错误
- `Network error`: 检测API不可用

### Q3: 如何停止自动运行?

A: 有两种方法:
1. 禁用工作流: Actions > ProxyIP检测 > 右上角 "..." > Disable workflow
2. 删除文件: 删除 `.github/workflows/check-proxy.yml`

### Q4: 免费额度够用吗?

A: GitHub Actions免费版:
- Public仓库: 无限制
- Private仓库: 每月2000分钟

每次检测约5-10分钟，每天6次 = 60分钟/天，完全够用。

### Q5: 可以同时运行多个检测吗?

A: 默认情况下，如果上一次检测还在运行，新的检测会排队等待。可以修改工作流添加:
```yaml
concurrency:
  group: proxy-check
  cancel-in-progress: true  # 取消正在运行的，执行新的
```

---

## 下一步

配置完成后，系统会:
1. ✅ 每4小时自动检测所有IP
2. ✅ 更新KV存储中的IP状态
3. ✅ 自动解析最优IP到Cloudflare DNS
4. ✅ 发送Telegram通知 (如果配置了)

你可以在Workers管理界面实时查看检测进度和结果。
